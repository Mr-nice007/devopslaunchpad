# Progress Tracking

## Feature Overview
Enable authenticated, enrolled users to mark/unmark lesson completion and persist timestamps. Provide real-time aggregation of module- and overall-progress for display on Dashboard and lesson headers. Ensure idempotent, low-latency operations with accurate, per-user progress state.

## Requirements
- Persist lesson completion per user with UTC timestamp.
- Idempotent mark/unmark actions (no duplicates; safe to repeat).
- Enforce access: only authenticated, enrolled users can modify/view their own progress.
- Aggregate progress:
  - Module progress: completed lessons / total lessons in module (0â€“100%).
  - Overall progress: completed lessons / total lessons in catalog accessible to the user.
- Immediate response includes updated aggregates for fast UI updates.
- Support read endpoints for:
  - User's completed lessons set
  - Module-level detail (per-lesson status + percent)
  - Overall summary
- Handle unpublished/locked lessons: cannot be marked complete; exclude from denominators.
- Timestamps must be ISO8601 UTC; server-generated by default.

## User Stories
- As an enrolled user, I can mark a lesson complete and see module and overall progress update instantly.
- As an enrolled user, I can unmark a lesson and see progress recalculate.
- As a user, I can view my per-module checklist and overall completion on the Dashboard.

## API Endpoints (JSON)
Auth: Auth.js session (userId from session/JWT). All endpoints require auth.

- POST /api/progress/lessons/{lessonId}
  - Purpose: Mark lesson complete (idempotent).
  - Body: { completedAt?: string(ISO8601) }
  - Responses:
    - 200: { lessonId, completed: true, completedAt, module: { moduleId, percent, completedCount, totalCount }, overall: { percent, completedCount, totalCount } }
    - 400: invalid lessonId or lesson not accessible/published
    - 403: not enrolled
    - 404: lesson not found
- DELETE /api/progress/lessons/{lessonId}
  - Purpose: Unmark completion (idempotent).
  - Responses analogous to POST with completed=false and completedAt=null.
- GET /api/progress/summary
  - Purpose: Overall summary.
  - 200: { percent, completedCount, totalCount }
- GET /api/progress/modules/{moduleId}
  - Purpose: Module detail and percent.
  - 200: { moduleId, percent, completedCount, totalCount, lessons: [{ lessonId, completed, completedAt|null }] }
  - 404 if module not found or inaccessible
- GET /api/progress/lessons
  - Purpose: List of completed lessons for current user.
  - 200: { lessons: [{ lessonId, completedAt }] }

Notes:
- Responses include only user's data. No cross-user access.
- Optional header Idempotency-Key supported; if provided, echo in response for observability (no storage required in MVP).

## Data Model (PostgreSQL via Prisma)
- progress
  - user_id UUID (FK users.id) NOT NULL
  - lesson_id UUID (FK lessons.id) NOT NULL
  - completed_at TIMESTAMPTZ NOT NULL
  - created_at TIMESTAMPTZ DEFAULT now()
  - updated_at TIMESTAMPTZ DEFAULT now()
  - PK (user_id, lesson_id)
  - Indexes: (user_id), (lesson_id)
Constraints:
- lessons.published = true and accessible (e.g., via enrollment/subscription) to be eligible.
- Unmark = delete row. Mark = upsert row with current timestamp if absent.

## Business Logic & Validation
- Enrollment check: active subscription (Stripe) or free access path required.
- Lesson validation: exists, published, not locked by prerequisites (if present, deny 409).
- Idempotency:
  - POST: if row exists, return existing completedAt.
  - DELETE: if absent, treat as success with completed=false.
- Aggregations:
  - Denominator excludes unpublished or inaccessible lessons.
  - Module lookup via lessons.module_id.
- Audit: updated_at changes on write.

## Security
- Auth required; userId from session; enforce user-level scoping server-side.
- Validate path params as UUIDv4.
- Rate limit write endpoints (e.g., 10 req/min/user) to prevent abuse.
- Do not expose other users' progress.

## Performance
- P95 < 150ms for writes and module summary; < 100ms for overall summary.
- Use COUNT queries with proper indexes; avoid N+1 by joining lessons filtered by module_id.
- Transaction boundary per request; upsert via ON CONFLICT (user_id, lesson_id).

## Success Criteria
- Users can mark/unmark lessons; responses include updated module/overall metrics.
- Dashboard and lesson header reflect changes immediately using API responses.
- Idempotent behavior verified via repeated requests.
- Aggregations exclude ineligible lessons and match UI percentages.
- Error handling returns correct status codes and messages.
